<html lang='en'>
<head>
	<title>Airly App</title>
	<meta charset="UTF-8">
	<!--loading libraries-->
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/places.js@1.18.1"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	
</head>
<body>
	<!-- search box and geolocation button-->
	<input type="search" id="address-input" class='address-input' placeholder="Wybierz lokacjÄ™" />
	<button id = "app" v-on:click="getLocation">Dane dla Twojej lokacji</button>
	
	<script>
		/*define Vue app*/
		var app = new Vue({
			el: '#app',
			data: {
				placesAutocomplete : places({
					appId: 'plZPOBCP5Q3T',
					apiKey: 'c1f1ec07ed62d4a064179ffe3bed383a',
					container: document.querySelector('#address-input')
				  })
			},
			created: function() {
				this.load_data({
								'city':'Warszawa',
								'country':'Polska',
								'latlng': {'lat': 52.2370,'lng':21.0175}
				});
				 this.placesAutocomplete.on('change', e => this.load_data(e.suggestion));
			},
			methods: {
				/*function loading wather and air pollution data*/
				load_data: function(loc_data) {

					let place = {"city": loc_data.city,
								"country": loc_data.country}
					
					/* loading pollution data in json */
					url = `https://airapi.airly.eu/v2/measurements/point?lat=${loc_data.latlng.lat}&lng=${loc_data.latlng.lng}`;
					var currXHR = new XMLHttpRequest();
					currXHR.onreadystatechange = function() {
						if (currXHR.readyState == 4 && currXHR.status == 200) {
							var json_data = JSON.parse(currXHR.responseText);
							var pollution = []
							for (let i =0; i <24;i+=3){
								let row = json_data.forecast[i]
								pollution.push({
												"date": row.fromDateTime.slice(0,10) + " " + row.fromDateTime.slice(11,19),
												"PM25":row.values[0].value,
												"PM10": row.values[1].value,
												"PM25%": row.standards[0].percent,
												"PM10%": row.standards[1].percent
								})
							}
						}
					};

					currXHR.open("GET", url);
					currXHR.setRequestHeader('Accept', 'application/json');
					currXHR.setRequestHeader('apikey', 'ALA45rSZm5sGrZ9I4ibJUq1U21O82AKR');
					currXHR.send();
					
					/* loading weather data in json */
					var forecastXHR = new XMLHttpRequest();
					forecastXHR.onreadystatechange = function(){
						if (forecastXHR.readyState == 4 && forecastXHR.status == 200){
							var json_data = JSON.parse(forecastXHR.responseText);
							var output = []
							for (let i = 0; i < 8; i++){
								var row = json_data.list[i]
								var rain_data = 0
								if (typeof row.main.rain != "undefined"){
									rain_data = row.main.rain("3h")
								};
								output.push({ "date" : row.dt_txt,
														"temperature": Math.round(row.main.temp - 273),
														"pressure": row.main.pressure,
														"wind": row.wind.speed,
														"rain": rain_data,
								})
							}
						}
					}
					
					forecastXHR.open('GET', `http://api.openweathermap.org/data/2.5/forecast?lat=${loc_data.latlng.lat}&lon=${loc_data.latlng.lng}&appid=96e1f29b74494a9d9469860a9ff96f14`);
					forecastXHR.send();
				},
				
				/* function checking geolocation and runing getCoords */
				getLocation: function() {
				  if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(this.getCoords);
				  } else {
					console.log("Geolocation is not supported by this browser.");
				  }
				},
				/*function retreiving coordinates for geolocation and running data load*/
				getCoords : function(position){
					var data_arg = {"latlng": {"lat": position.coords.latitude,
												"lng": position.coords.longitude}
										}
					this.load_data(data_arg)
				}
			}
		});
	</script>
</body>

</html>